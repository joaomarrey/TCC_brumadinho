---
title: "brumadinho_synthetic_control_emprego_rais"
output: html_document
date: "2025-08-16"
---

```{r}
library(Synth)
library(ggplot2)
library(reshape2)
library(scales)
```


```{r}

raw_data_path = file.path(dirname(getwd()), "data_new", "raw_data") 
manipulated_data_path = file.path(dirname(getwd()), "data_new", "manipulated_data")
final_data_path = file.path(dirname(getwd()), "data_new", "final_data")
matching_data_path = file.path(dirname(getwd()), "data_new", "matching_data")

```


```{r}

final_df = read.csv(file.path(final_data_path, "dados_finais_municipios.csv"))

```


```{r}
test_balance = table(final_df$ANO, final_df$NOME_MUN)
test_balance = as.data.frame.matrix(test_balance)
write.csv(test_balance, file.path(final_data_path, "test_balance.csv"))
```



###CONTROLE SINTÃ‰TICO COM DOWNSTREAM

```{r}
#synth_data new matching
matched_control_group = read.csv(file.path(matching_data_path, 'matching_k_nearest_emprego.csv'))

synth_data = dataprep(
  foo = final_df,
  predictors = c(
                 "VINCULOS_ATIVOS",
                 #"REMUNERACAO_DEZEMBRO",
                 "REMUNERACAO_MEDIA",
                 "PIB_PER_CAPITA", "POP", "PROPORCAO_DA_POP_RURAL", 
                 "VA_AGRO_PER_CAPITA", "VA_IND_PER_CAPITA", "VA_SERV_PER_CAPITA", 
                 "VA_ADM_PER_CAPITA", "VA_AGRO_SOBRE_VA_TOT", "VA_IND_SOBRE_VA_TOT", 
                 "VA_SERV_SOBRE_VA_TOT", "VA_ADM_SOBRE_VA_TOT", "EXP_VIDA_AO_NASCER", 
                 "MORTALIDADE_INFANTIL", "IDHM_RENDA", "IDHM_LONGEVIDADE", 
                 "IDHM_EDU", 
                 #"REND_MEDIO_FORMAL", 
                 "TRANSF_PER_CAPITA_BOLSA_FAMILIA"
                 ,
                 'GINI', 'TAXA_ALFAB', 'PROP_MENOS_DE_1_SM', 'PROP_1_A_2_SM', 
                 'PROP_2_A_5_SM', 'PROP_5_A_10_SM', 'PROP_MAIS_DE_10_SM'
                 #,
                 #'VA_AGRO', 'VA_IND', 'VA_SERV', 'VA_ADM',
                 #'VA_TOT'
                 ),
  dependent = "VINCULOS_ATIVOS",
  unit.variable = "COD_MUN",
  unit.names.variable = "NOME_MUN",   # add this back
  time.variable = "ANO",
  treatment.identifier = 3109006,     # careful: no quotes, must be numeric if COD_MUN is numeric
  controls.identifier = matched_control_group$COD_MUN,
  #controls.identifier = c(3145901, 3118007, 3131901, 3133758, 3151107, 3141108, 3133006, 3165537, 3104205, 3146107, 3130408, 3149309, 3155702,                                 3172004, 3133709, 3140001, 3136652, 3168705, 3136207, 3144805, 3105400, 3137601, 3106309, 3132404, 3145208, 3133808,                                 3125101, 3106002, 3140803, 3104007),
  time.predictors.prior = 2002:2018,
  time.optimize.ssr = 2002:2018,
  time.plot = 2002:2023
)
```


```{r}

synth_output = synth(synth_data)

```



```{r}
path.plot(synth.res = synth_output,
dataprep.res = synth_data)
```


```{r}
# Get actual treated series
Y1  <- synth_data$Y1plot  

# Get synthetic control series
Y1s <- synth_data$Y0plot %*% synth_output$solution.w  

# Time variable
time <- synth_data$tag$time.plot

synthetic_df <- data.frame(
  Year = time,
  Value = as.numeric(Y1s)
)

treated_df <- data.frame(
  Year = time,
  Value = as.numeric(Y1)
)
  
plot_df <- data.frame(
  Year = time,
  Treated = as.numeric(Y1),
  Synthetic = as.numeric(Y1s)
)
```





```{r}
ggplot() +
  # synthetic line and points (dashed)
  geom_line(data = synthetic_df, aes(x = Year, y = Value, color = "Synthetic Control"), 
            size = 1.3, linetype = "dashed") +
  geom_point(data = synthetic_df, aes(x = Year, y = Value, color = "Synthetic Control"), size = 2.5) +
  
  # treated line and points (solid)
  geom_line(data = treated_df, aes(x = Year, y = Value, color = "Treated Unit"), 
            size = 1.3, linetype = "solid") +
  geom_point(data = treated_df, aes(x = Year, y = Value, color = "Treated Unit"), size = 2.5) +
  
  # vertical line for treatment
  geom_vline(xintercept = 2019, linetype = "dotted", color = "black", size = 1) +
  
  scale_x_continuous(
    breaks = seq(min(plot_df$Year), max(plot_df$Year), by = 1)
  ) +
  scale_y_continuous(
    breaks = seq(0, max(plot_df$Treated, plot_df$Synthetic), by = 1250),
    labels = label_number(big.mark = ".", decimal.mark = ",", prefix = "")
  ) +
  
  # define custom colors for the legend
  scale_color_manual(
    name = "",  # legend title (empty for none)
    values = c("Treated Unit" = "#56BCC2", "Synthetic Control" = "#E87D72")
  ) +
  
  theme_minimal() +
  labs(
    title = "Treated Unit vs Synthetic Control",
    x = "Year",
    y = "Employment"
  ) +
  theme(
    text = element_text(size = 10),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.y = element_line(color = "gray95", size = 0.7),
    panel.grid.minor.y = element_line(color = "gray95", size = 0.3),
    legend.position = "bottom"
  ) +
  annotate("text", x = 2019, y = max(plot_df$Treated, plot_df$Synthetic),
           label = "Treatment Year", hjust = 1.1)
```


```{r}
gaps.plot(synth.res = synth_output,
dataprep.res = synth_data)
```


```{r}

gap_data = data.frame(
  Year = plot_df$Year,
  Gap  = plot_df$Treated - plot_df$Synthetic
)


variance = sum(gap_data[gap_data$Year <= 2018, "Gap"] ^ 2) / (2018 - 2001)
std_error = variance ^ (1 / 2)
std_error

# If you have std errors from placebo tests / bootstraps, add them here
gap_data$Variance = variance
gap_data$Std_Error = std_error  # placeholder, otherwise use real values

gap_data

```



```{r}

# Label pre vs post
treatment_year <- 2019
gap_data$Group <- ifelse(gap_data$Year < treatment_year, "Pre", "Post")
gap_data$Group <- factor(gap_data$Group, levels = c("Pre", "Post"))

# Convert Year to a fake "Coefficient" column like your DiD code
gap_data$Coefficient <- paste0("tr", gap_data$Year)

# Plot (exact same style as your DiD)
sp <- ggplot(gap_data, aes(x = Coefficient, y = Gap,
                           ymin = Gap - 1.96 * Std_Error,
                           ymax = Gap + 1.96 * Std_Error,
                           color = Group)) +
  geom_point(size = 3) +
  geom_errorbar(width = 0.2, na.rm = TRUE) +  # will show only if Std_Error available
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  labs(title = "", x = "Coefficient", y = "Gap") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

sp <- sp + scale_color_manual(values = c("Pre" = "#E87D72", "Post" = "#56BCC2"))

sp <- sp + theme(panel.grid = element_blank())
sp <- sp + theme(axis.line = element_line(), axis.ticks = element_line())
sp <- sp + theme(
  axis.title = element_blank(),
  axis.text.x = element_text(size = 12, color = "black", hjust = 0.5, angle = -45),
  axis.text.y = element_text(size = 12, color = "black")
)

# Make x-axis nice with actual years
sp <- sp + scale_x_discrete(
  breaks = paste0("tr", gap_data$Year),
  labels = as.character(gap_data$Year)
)

sp <- sp + theme(legend.position = "bottom", legend.title = element_blank())
sp
```

