---
title: "brumadinho_synthetic_control_gdp"
output: html_document
date: "2025-08-16"
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
```


```{r}
#install.packages("Synth")
#install.packages("dyplr")
```

```{r}
library(Synth)
library(ggplot2)
library(reshape2)
library(scales)
library(dplyr)
```

```{r}

raw_data_path = file.path(dirname(getwd()), "data_new", "raw_data") 
manipulated_data_path = file.path(dirname(getwd()), "data_new", "manipulated_data")
final_data_path = file.path(dirname(getwd()), "data_new", "final_data")
matching_data_path = file.path(dirname(getwd()), "data_new", "matching_data")

```


```{r}

final_df = read.csv(file.path(final_data_path, "dados_finais_municipios.csv"))
#final_df = read.csv(file.path(final_data_path, "dados_finais_municipios_padronizado.csv"))

```


```{r}
test_balance = table(final_df$ANO, final_df$NOME_MUN)
test_balance = as.data.frame.matrix(test_balance)
write.csv(test_balance, file.path(final_data_path, "test_balance.csv"))
```


###CONTROLE SINTÉTICO COM DOWNSTREAM

```{r}
special_predictors = list(
    list("PIB_PER_CAPITA", 2002, "mean"),
    list("PIB_PER_CAPITA", 2003, "mean"),
    list("PIB_PER_CAPITA", 2004, "mean"),
    list("PIB_PER_CAPITA", 2005, "mean"),
    list("PIB_PER_CAPITA", 2006, "mean"),
    list("PIB_PER_CAPITA", 2007, "mean"),
    list("PIB_PER_CAPITA", 2008, "mean"),
    list("PIB_PER_CAPITA", 2009, "mean"),
    list("PIB_PER_CAPITA", 2010, "mean"),
    list("PIB_PER_CAPITA", 2011, "mean"),
    list("PIB_PER_CAPITA", 2012, "mean"),
    list("PIB_PER_CAPITA", 2013, "mean"),
    list("PIB_PER_CAPITA", 2014, "mean"),
    list("PIB_PER_CAPITA", 2015, "mean"),
    list("PIB_PER_CAPITA", 2016, "mean"),
    list("PIB_PER_CAPITA", 2017, "mean"),
    list("PIB_PER_CAPITA", 2018, "mean")
    
#    ,
#    list("REMUNERACAO_MEDIA", 2002, "mean"),
#    list("REMUNERACAO_MEDIA", 2003, "mean"),
#    list("REMUNERACAO_MEDIA", 2004, "mean"),
#    list("REMUNERACAO_MEDIA", 2005, "mean"),
#    list("REMUNERACAO_MEDIA", 2006, "mean"),
#    list("REMUNERACAO_MEDIA", 2007, "mean"),
#    list("REMUNERACAO_MEDIA", 2008, "mean"),
#    list("REMUNERACAO_MEDIA", 2009, "mean"),
#    list("REMUNERACAO_MEDIA", 2010, "mean"),
#   list("REMUNERACAO_MEDIA", 2011, "mean"),
#    list("REMUNERACAO_MEDIA", 2012, "mean"),
#    list("REMUNERACAO_MEDIA", 2013, "mean"),
#    list("REMUNERACAO_MEDIA", 2014, "mean"),
#    list("REMUNERACAO_MEDIA", 2015, "mean"),
#    list("REMUNERACAO_MEDIA", 2016, "mean"),
#    list("REMUNERACAO_MEDIA", 2017, "mean"),
#    list("REMUNERACAO_MEDIA", 2018, "mean")
    
#    ,
    #list("PROP_MEDIA_POP_EMPREGADA", 2002, "mean"),
    #list("PROP_MEDIA_POP_EMPREGADA", 2003, "mean"),
    #list("PROP_MEDIA_POP_EMPREGADA", 2004, "mean"),
    #list("PROP_MEDIA_POP_EMPREGADA", 2005, "mean"),
    #list("PROP_MEDIA_POP_EMPREGADA", 2006, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2007, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2008, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2009, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2010, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2011, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2012, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2013, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2014, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2015, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2016, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2017, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2018, "mean")
  )

normal_predictors = c(
    #NULL
                  #"REMUNERACAO_MEDIA",
                  #"PROP_MEDIA_POP_EMPREGADA",                 
                  "POP", 
                  
                  #"VA_AGRO_PER_CAPITA", "VA_IND_PER_CAPITA", 
                  #"VA_SERV_PER_CAPITA", "VA_ADM_PER_CAPITA", 
                  
                  "VA_AGRO_SOBRE_VA_TOT", "VA_IND_SOBRE_VA_TOT", 
                  "VA_SERV_SOBRE_VA_TOT", "VA_ADM_SOBRE_VA_TOT",
                  
                  "IDHM_RENDA", "IDHM_LONGEVIDADE", "IDHM_EDU", 
                  "TRANSF_PER_CAPITA_BOLSA_FAMILIA",
                  'GINI', 
                  'TAXA_ALFAB'
                  #, 
                  #'PROP_MENOS_DE_1_SM', 'PROP_1_A_2_SM', 
                  #'PROP_2_A_5_SM', 'PROP_5_A_10_SM', 'PROP_MAIS_DE_10_SM'
                 )

#synth_data new matching
matched_control_group = read.csv(file.path(matching_data_path, 'matching_k_nearest_pib.csv'))

synth_data = dataprep(
  foo = final_df,
  predictors = normal_predictors,
  special.predictors = special_predictors,
  dependent = "PIB_PER_CAPITA",
  unit.variable = "COD_MUN",
  unit.names.variable = "NOME_MUN",   # add this back
  time.variable = "ANO",
  treatment.identifier = 3109006,     # careful: no quotes, must be numeric if COD_MUN is numeric
  controls.identifier = matched_control_group$COD_MUN,
  time.predictors.prior = 2002:2018,
  time.optimize.ssr = 2002:2018,
  time.plot = 2002:2021
)
```




```{r}

synth_output = synth(synth_data)

```


```{r}
Y1 <- synth_data$Y1plot
Y0s <- synth_data$Y0plot %*% synth_output$solution.w
years <- synth_data$tag$time.plot

pre_idx <- which(years %in% 2002:2018)
post_idx <- which(years > max(2002:2018))

treated_pre_rmspe  <- sqrt(mean((Y1[pre_idx] - Y0s[pre_idx])^2, na.rm=TRUE))
treated_post_rmspe <- sqrt(mean((Y1[post_idx] - Y0s[post_idx])^2, na.rm=TRUE))
treated_ratio <- ifelse(treated_pre_rmspe == 0, NA, treated_post_rmspe / treated_pre_rmspe)
treated_ratio
```



```{r}
path.plot(synth.res = synth_output,
dataprep.res = synth_data)
```


```{r}
# Get actual treated series
Y1  <- synth_data$Y1plot  

# Get synthetic control series
Y1s <- synth_data$Y0plot %*% synth_output$solution.w  

# Time variable
time <- synth_data$tag$time.plot

synthetic_df <- data.frame(
  Year = time,
  Value = as.numeric(Y1s)
)

treated_df <- data.frame(
  Year = time,
  Value = as.numeric(Y1)
)
  
plot_df <- data.frame(
  Year = time,
  Treated = as.numeric(Y1),
  Synthetic = as.numeric(Y1s)
)
```




```{r}

ggplot() +
  # synthetic line and points (dashed)
  geom_line(data = synthetic_df, aes(x = Year, y = Value, color = "Synthetic Control"), 
            size = 1.3, linetype = "dashed") +
  geom_point(data = synthetic_df, aes(x = Year, y = Value, color = "Synthetic Control"), size = 2.5) +
  
  # treated line and points (solid)
  geom_line(data = treated_df, aes(x = Year, y = Value, color = "Treated Unit"), 
            size = 1.3, linetype = "solid") +
  geom_point(data = treated_df, aes(x = Year, y = Value, color = "Treated Unit"), size = 2.5) +
  
  # vertical line for treatment
  geom_vline(xintercept = 2019, linetype = "dotted", color = "black", size = 1) +
  
  scale_x_continuous(
    breaks = seq(min(plot_df$Year), max(plot_df$Year), by = 1)
  ) +
  scale_y_continuous(
    breaks = seq(0, max(plot_df$Treated, plot_df$Synthetic), by = 25000),
    labels = label_number(big.mark = ".", decimal.mark = ",", prefix = "R$ ")
  ) +
  
  # define custom colors for the legend
  scale_color_manual(
    name = "",  # legend title (empty for none)
    values = c("Treated Unit" = "#56BCC2", "Synthetic Control" = "#E87D72")
  ) +
  
  theme_minimal() +
  labs(
    title = "Treated Unit vs Synthetic Control",
    x = "Year",
    y = "GDP Per Capita (R$)"
  ) +
  theme(
    text = element_text(size = 10),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.y = element_line(color = "gray95", size = 0.7),
    panel.grid.minor.y = element_line(color = "gray95", size = 0.3),
    legend.position = "bottom"
  ) +
  annotate("text", x = 2019, y = max(plot_df$Treated, plot_df$Synthetic),
           label = "Treatment Year", hjust = 1.1)
```



```{r}
gaps.plot(synth.res = synth_output,
dataprep.res = synth_data)
```



```{r}

gap_data = data.frame(
  Year = plot_df$Year,
  Gap  = plot_df$Treated - plot_df$Synthetic
)


variance = sum(gap_data[gap_data$Year <= 2018, "Gap"] ^ 2) / (2018 - 2001)
std_error = variance ^ (1 / 2)
std_error

# If you have std errors from placebo tests / bootstraps, add them here
gap_data$Variance = variance
gap_data$Std_Error = std_error  # placeholder, otherwise use real values

gap_data

```




```{r}

# Label pre vs post
treatment_year <- 2019
gap_data$Group <- ifelse(gap_data$Year < treatment_year, "Pre", "Post")
gap_data$Group <- factor(gap_data$Group, levels = c("Pre", "Post"))

# Convert Year to a fake "Coefficient" column like your DiD code
gap_data$Coefficient <- paste0("tr", gap_data$Year)

# Plot (exact same style as your DiD)
sp <- ggplot(gap_data, aes(x = Coefficient, y = Gap,
                           ymin = Gap - 1.96 * Std_Error,
                           ymax = Gap + 1.96 * Std_Error,
                           color = Group)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(width = 0.2, na.rm = TRUE) +  # will show only if Std_Error available
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  labs(title = "", x = "Coefficient", y = "Gap") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#sp <- sp + geom_line(data = gap_data, aes(x = Coefficient, y = Gap, color = "#E87D72"), size = 1.3, linetype = "solid")


sp <- sp + scale_color_manual(values = c("Pre" = "#E87D72", "Post" = "#56BCC2"))

sp <- sp + theme(panel.grid = element_blank())
sp <- sp + theme(axis.line = element_line(), axis.ticks = element_line())
sp <- sp + theme(
  axis.title = element_blank(),
  axis.text.x = element_text(size = 12, color = "black", hjust = 0.5, angle = -45),
  axis.text.y = element_text(size = 12, color = "black")
)

# Make x-axis nice with actual years
sp <- sp + scale_x_discrete(
  breaks = paste0("tr", gap_data$Year),
  labels = as.character(gap_data$Year)
)

sp <- sp + theme(legend.position = "bottom", legend.title = element_blank())
sp
```



```{r}
sp <- ggplot(gap_data, aes(x = Coefficient, y = Gap, color = Group)) +
  geom_line(aes(group = 1), size = 0.8) +  # <--- this ensures all points are connected
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = Gap - 1.96 * Std_Error, ymax = Gap + 1.96 * Std_Error),
                width = 0.2, na.rm = TRUE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(values = c("Pre" = "#E87D72", "Post" = "#56BCC2")) +
  scale_x_discrete(breaks = paste0("tr", gap_data$Year),
                   labels = as.character(gap_data$Year)) +
  labs(
    title = "Gap between Treated Unit and Synthetic Control",
    x = "Year",
    y = "Gap in GDP Per Capita (R$)"
  ) +
  scale_y_continuous(
    labels = label_number(big.mark = ".", decimal.mark = ",", prefix = "R$ ")
  ) +
  theme_minimal() +
  theme(text = element_text(size = 10),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.y = element_line(color = "gray95", size = 0.7),
        panel.grid.minor.y = element_line(color = "gray95", size = 0.3),
        legend.position = "bottom") +
  annotate("text", x = "tr2019", y = min(gap_data$Gap), label = "Treatment Year", hjust = 1.1)+
  geom_vline(xintercept = which(levels(factor(gap_data$Coefficient)) == "tr2019"), 
           linetype = "dotted", color = "black", size = 1)
  #geom_vline(xintercept = 2019, linetype = "dotted", color = "black", size = 1)
sp
```



```{r}

cods = unique(matched_control_group$COD_MUN)
names = unique(matched_control_group$NOME_MUN)
#indexes = 1:length(cods)

count = 0

placebo_results <- list()
rmspe_stats <- data.frame()

for (i in seq_along(cods)) {
  treated_cod = cods[i]
  treated_name = names[i]
  count = count + 1
  
  cat("Running placebo for:", treated_name, "(", treated_cod, ")\n")
  cat("COUNT: ", count)
  
  donor_pool_cods = setdiff(cods, treated_cod)
  #donor_pool_names = setdiff(names, treated_name)
  
  # Try-catch to skip units that fail
  try({
    synth_data_placebo = dataprep(
                                  foo = final_df,
                                  predictors = normal_predictors,
                                  special.predictors = special_predictors,
                                  dependent = "PIB_PER_CAPITA",
                                  unit.variable = "COD_MUN",
                                  unit.names.variable = "NOME_MUN",   # add this back
                                  time.variable = "ANO",
                                  treatment.identifier = treated_cod,     # careful: no quotes, must be numeric if COD_MUN is numeric
                                  controls.identifier = donor_pool_cods,
                                  time.predictors.prior = 2002:2018,
                                  time.optimize.ssr = 2002:2018,
                                  time.plot = 2002:2021
                                )
    
    cat("COUNT: ", count)
    
    synth_output_placebo = synth(synth_data_placebo)
    
    # Extract treated vs synthetic
    Y1 <- synth_data_placebo$Y1plot
    Y0s <- synth_data_placebo$Y0plot %*% synth_output_placebo$solution.w
    years <- synth_data_placebo$tag$time.plot
    
    # Store Gaps
    gap <- Y1 - Y0s
    placebo_results[[as.character(treated_cod)]] <- data.frame(
      Year = years,
      COD_MUN = treated_cod,
      NOME_MUN = treated_name,
      Y1 = unname(Y1),
      Y0s = unname(Y0s),
      Gap = unname(gap),
      pre_rmspe = pre_rmspe,
      post_rmspe = post_rmspe,
      ratio = ratio
    )
    #print("WORKED")
    #placebo_results[[as.character(treated_cod)]] <- data.frame( Year = years, Gap = gap, COD_MUN = treated_cod, NOME_MUN = treated_name )
    
    # Compute RMSPE ratios
    pre_idx <- which(years %in% 2002:2018)
    post_idx <- which(years > max(2002:2018))
    
    pre_rmspe  <- sqrt(mean((Y1[pre_idx] - Y0s[pre_idx])^2, na.rm=TRUE))
    post_rmspe <- sqrt(mean((Y1[post_idx] - Y0s[post_idx])^2, na.rm=TRUE))
    ratio <- ifelse(pre_rmspe == 0, NA, post_rmspe / pre_rmspe)
    
    rmspe_stats <- rbind(rmspe_stats,
                       data.frame(COD_MUN = treated_cod,
                                  pre_rmspe = pre_rmspe,
                                  post_rmspe = post_rmspe,
                                  ratio = ratio))
    
  }, silent = FALSE)
}


```



```{r}
# Ensure all elements are data.frames and have identical columns
placebo_results_clean <- placebo_results[sapply(placebo_results, is.data.frame)]

# Get full set of columns
all_cols <- Reduce(union, lapply(placebo_results_clean, names))

# Add missing columns as NA to each data.frame
placebo_results_clean <- lapply(placebo_results_clean, function(df) {
  missing_cols <- setdiff(all_cols, names(df))
  for (col in missing_cols) df[[col]] <- NA
  df[all_cols]
})

# Combine
placebo_df <- do.call(rbind, placebo_results_clean)

good_units <- rmspe_stats$COD_MUN[rmspe_stats$pre_rmspe <= 5 * treated_pre_rmspe]
placebo_df_filtered <- subset(placebo_df, COD_MUN %in% good_units)
rmspe_stats_filtered <- subset(rmspe_stats, COD_MUN %in% good_units)
length(good_units)
```



```{r}
sp <- ggplot() +
  # --- Placebo lines first (gray background lines) ---
  geom_line(data = placebo_df_filtered,
            aes(x = Year, y = Gap, group = COD_MUN),
            color = "gray70", alpha = 0.7) +

  # --- Treated unit ---
  geom_line(data = gap_data,
            aes(x = Year, y = Gap, color = Group, group = 1),
            size = 0.8) +
  geom_point(data = gap_data,
             aes(x = Year, y = Gap, color = Group),
             size = 3) +
  #geom_errorbar(data = gap_data,
  #              aes(x = Year,
  #                  ymin = Gap - 1.96 * Std_Error,
  #                  ymax = Gap + 1.96 * Std_Error,
  #                  color = Group),
  #              width = 0.2, na.rm = TRUE) +

  # --- Horizontal zero line ---
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +

  # --- Treatment line + label ---
  geom_vline(xintercept = 2019, linetype = "dotted", color = "black", size = 1) +
  annotate("text", x = 2019, y = min(gap_data$Gap),
           label = "Treatment Year", hjust = 1.1, vjust = -0.5, size = 3.5) +

  # --- Scales and labels ---
  scale_color_manual(values = c("Pre" = "#E87D72", "Post" = "#56BCC2")) +
  scale_y_continuous(
    labels = label_number(big.mark = ".", decimal.mark = ",", prefix = "R$ ")
  ) +
  scale_x_continuous(breaks = gap_data$Year, labels = gap_data$Year) +

  # --- Titles and theme ---
  labs(
    title = "Gaps for Treated and Control Units (Placebo Test)",
    subtitle = "Placebo tests in gray; treated unit in color",
    x = "Year",
    y = "Gap in GDP Per Capita (R$)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 10),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.y = element_line(color = "gray95", size = 0.7),
    panel.grid.minor.y = element_line(color = "gray95", size = 0.3),
    legend.position = "bottom"
  )

sp
```



```{r}

p_value <- mean(rmspe_stats_filtered$ratio >= treated_ratio, na.rm = TRUE)
#p_value <- mean(rmspe_stats_filtered$ratio >= 9, na.rm = TRUE)
p_value

```

```{r}
ggplot(rmspe_stats_filtered, aes(x = ratio)) +
  geom_histogram(binwidth = 1, fill = "gray70", color = "white", alpha = 0.8) +
  geom_vline(xintercept = treated_ratio, color = "#E87D72", size = 1.3) +
  annotate("text", x = treated_ratio, y = Inf,
           label = paste0("Treated (p = ", round(p_value, 3), ")"),
           vjust = 2, hjust = 1.1, color = "#E87D72", size = 4) +
  labs(
    title = "Placebo Test: Distribution of Post/Pre RMSPE Ratios",
    x = "Post/Pre RMSPE Ratio",
    y = "Number of Units"
  ) +
  theme_minimal() + 
  theme(
      panel.grid.major.y = element_line(color = "gray95", size = 0.7),
      panel.grid.minor.y = element_line(color = "gray95", size = 0.3)
    )

```


```{r}
ggplot(rmspe_stats_filtered, aes(x = ratio)) +
  geom_density(fill = "gray80", alpha = 0.8) +
  geom_vline(xintercept = treated_ratio, color = "#E87D72", size = 1.2) +
  annotate("text", x = treated_ratio, y = 0, hjust = 1.1, vjust = -1,
           label = paste0("Treated (p = ", round(p_value, 3), ")"),
           color = "#E87D72") +
  labs(
    title = "Placebo Test Distribution",
    x = "Post/Pre RMSPE Ratio",
    y = "Density"
  ) +
  theme_minimal()
```



### CONTROLE SINTÉTICO SEM DOWNSTREAM

```{r}
special_predictors = list(
    list("PIB_PER_CAPITA", 2002, "mean"),
    list("PIB_PER_CAPITA", 2003, "mean"),
    list("PIB_PER_CAPITA", 2004, "mean"),
    list("PIB_PER_CAPITA", 2005, "mean"),
    list("PIB_PER_CAPITA", 2006, "mean"),
    list("PIB_PER_CAPITA", 2007, "mean"),
    list("PIB_PER_CAPITA", 2008, "mean"),
    list("PIB_PER_CAPITA", 2009, "mean"),
    list("PIB_PER_CAPITA", 2010, "mean"),
    list("PIB_PER_CAPITA", 2011, "mean"),
    list("PIB_PER_CAPITA", 2012, "mean"),
    list("PIB_PER_CAPITA", 2013, "mean"),
    list("PIB_PER_CAPITA", 2014, "mean"),
    list("PIB_PER_CAPITA", 2015, "mean"),
    list("PIB_PER_CAPITA", 2016, "mean"),
    list("PIB_PER_CAPITA", 2017, "mean"),
    list("PIB_PER_CAPITA", 2018, "mean")
    
#    ,
#    list("REMUNERACAO_MEDIA", 2002, "mean"),
#    list("REMUNERACAO_MEDIA", 2003, "mean"),
#    list("REMUNERACAO_MEDIA", 2004, "mean"),
#    list("REMUNERACAO_MEDIA", 2005, "mean"),
#    list("REMUNERACAO_MEDIA", 2006, "mean"),
#    list("REMUNERACAO_MEDIA", 2007, "mean"),
#    list("REMUNERACAO_MEDIA", 2008, "mean"),
#    list("REMUNERACAO_MEDIA", 2009, "mean"),
#    list("REMUNERACAO_MEDIA", 2010, "mean"),
#    list("REMUNERACAO_MEDIA", 2011, "mean"),
#    list("REMUNERACAO_MEDIA", 2012, "mean"),
#    list("REMUNERACAO_MEDIA", 2013, "mean"),
#    list("REMUNERACAO_MEDIA", 2014, "mean"),
#    list("REMUNERACAO_MEDIA", 2015, "mean"),
#    list("REMUNERACAO_MEDIA", 2016, "mean"),
#    list("REMUNERACAO_MEDIA", 2017, "mean"),
#    list("REMUNERACAO_MEDIA", 2018, "mean")
    
#    ,
    #list("PROP_MEDIA_POP_EMPREGADA", 2002, "mean"),
    #list("PROP_MEDIA_POP_EMPREGADA", 2003, "mean"),
    #list("PROP_MEDIA_POP_EMPREGADA", 2004, "mean"),
    #list("PROP_MEDIA_POP_EMPREGADA", 2005, "mean"),
    #list("PROP_MEDIA_POP_EMPREGADA", 2006, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2007, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2008, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2009, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2010, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2011, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2012, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2013, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2014, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2015, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2016, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2017, "mean"),
#    list("PROP_MEDIA_POP_EMPREGADA", 2018, "mean")
)

normal_predictors = c(
    #NULL
                  #"REMUNERACAO_MEDIA",
                  #"PROP_MEDIA_POP_EMPREGADA",                 
                  "POP", 
                  
                  #"VA_AGRO_PER_CAPITA", "VA_IND_PER_CAPITA", 
                  #"VA_SERV_PER_CAPITA", "VA_ADM_PER_CAPITA", 
                  
                  "VA_AGRO_SOBRE_VA_TOT", "VA_IND_SOBRE_VA_TOT", 
                  "VA_SERV_SOBRE_VA_TOT", "VA_ADM_SOBRE_VA_TOT",
                  
                  "IDHM_RENDA", "IDHM_LONGEVIDADE", "IDHM_EDU", 
                  "TRANSF_PER_CAPITA_BOLSA_FAMILIA",
                  'GINI', 
                  'TAXA_ALFAB'
                  #, 
                  #'PROP_MENOS_DE_1_SM', 'PROP_1_A_2_SM', 
                  #'PROP_2_A_5_SM', 'PROP_5_A_10_SM', 'PROP_MAIS_DE_10_SM'
                 )


#synth_data new matching
matched_control_group = read.csv(file.path(matching_data_path, 'matching_k_nearest_no_downstream_pib.csv'))

synth_data = dataprep(
  foo = final_df,
  predictors = normal_predictors,
  special.predictors = special_predictors,
  dependent = "PIB_PER_CAPITA",
  unit.variable = "COD_MUN",
  unit.names.variable = "NOME_MUN",   # add this back
  time.variable = "ANO",
  treatment.identifier = 3109006,     # careful: no quotes, must be numeric if COD_MUN is numeric
  controls.identifier = matched_control_group$COD_MUN,
  time.predictors.prior = 2002:2018,
  time.optimize.ssr = 2002:2018,
  time.plot = 2002:2021
)
```



```{r}

synth_output = synth(synth_data)

```


```{r}
path.plot(synth.res = synth_output,
dataprep.res = synth_data)
```



```{r}
# Get actual treated series
Y1  <- synth_data$Y1plot  

# Get synthetic control series
Y1s <- synth_data$Y0plot %*% synth_output$solution.w  

# Time variable
time <- synth_data$tag$time.plot

synthetic_df <- data.frame(
  Year = time,
  Value = as.numeric(Y1s)
)

treated_df <- data.frame(
  Year = time,
  Value = as.numeric(Y1)
)
  
plot_df <- data.frame(
  Year = time,
  Treated = as.numeric(Y1),
  Synthetic = as.numeric(Y1s)
)
```



```{r}

ggplot() +
  # synthetic line and points (dashed)
  geom_line(data = synthetic_df, aes(x = Year, y = Value, color = "Synthetic Control"), 
            size = 1.3, linetype = "dashed") +
  geom_point(data = synthetic_df, aes(x = Year, y = Value, color = "Synthetic Control"), size = 2.5) +
  
  # treated line and points (solid)
  geom_line(data = treated_df, aes(x = Year, y = Value, color = "Treated Unit"), 
            size = 1.3, linetype = "solid") +
  geom_point(data = treated_df, aes(x = Year, y = Value, color = "Treated Unit"), size = 2.5) +
  
  # vertical line for treatment
  geom_vline(xintercept = 2019, linetype = "dotted", color = "black", size = 1) +
  
  scale_x_continuous(
    breaks = seq(min(plot_df$Year), max(plot_df$Year), by = 1)
  ) +
  scale_y_continuous(
    breaks = seq(0, max(plot_df$Treated, plot_df$Synthetic), by = 25000),
    labels = label_number(big.mark = ".", decimal.mark = ",", prefix = "R$ ")
  ) +
  
  # define custom colors for the legend
  scale_color_manual(
    name = "",  # legend title (empty for none)
    values = c("Treated Unit" = "#56BCC2", "Synthetic Control" = "#E87D72")
  ) +
  
  theme_minimal() +
  labs(
    title = "Treated Unit vs Synthetic Control",
    x = "Year",
    y = "GDP Per Capita (R$)"
  ) +
  theme(
    text = element_text(size = 10),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.y = element_line(color = "gray95", size = 0.7),
    panel.grid.minor.y = element_line(color = "gray95", size = 0.3),
    legend.position = "bottom"
  ) +
  annotate("text", x = 2019, y = max(plot_df$Treated, plot_df$Synthetic),
           label = "Treatment Year", hjust = 1.1)

```


```{r}
gaps.plot(synth.res = synth_output,
dataprep.res = synth_data)
```



```{r}

gap_data = data.frame(
  Year = plot_df$Year,
  Gap  = plot_df$Treated - plot_df$Synthetic
)


variance = sum(gap_data[gap_data$Year <= 2018, "Gap"] ^ 2) / (2018 - 2001)
std_error = variance ^ (1 / 2)
std_error

# If you have std errors from placebo tests / bootstraps, add them here
gap_data$Variance = variance
gap_data$Std_Error = std_error  # placeholder, otherwise use real values

gap_data

```




```{r}

# Label pre vs post
treatment_year <- 2019
gap_data$Group <- ifelse(gap_data$Year < treatment_year, "Pre", "Post")
gap_data$Group <- factor(gap_data$Group, levels = c("Pre", "Post"))

# Convert Year to a fake "Coefficient" column like your DiD code
gap_data$Coefficient <- paste0("tr", gap_data$Year)

# Plot (exact same style as your DiD)
sp <- ggplot(gap_data, aes(x = Coefficient, y = Gap,
                           ymin = Gap - 1.96 * Std_Error,
                           ymax = Gap + 1.96 * Std_Error,
                           color = Group)) +
  geom_point(size = 3) +
  geom_errorbar(width = 0.2, na.rm = TRUE) +  # will show only if Std_Error available
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  labs(title = "", x = "Coefficient", y = "Gap") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

sp <- sp + scale_color_manual(values = c("Pre" = "#E87D72", "Post" = "#56BCC2"))

sp <- sp + theme(panel.grid = element_blank())
sp <- sp + theme(axis.line = element_line(), axis.ticks = element_line())
sp <- sp + theme(
  axis.title = element_blank(),
  axis.text.x = element_text(size = 12, color = "black", hjust = 0.5, angle = -45),
  axis.text.y = element_text(size = 12, color = "black")
)

# Make x-axis nice with actual years
sp <- sp + scale_x_discrete(
  breaks = paste0("tr", gap_data$Year),
  labels = as.character(gap_data$Year)
)

sp <- sp + theme(legend.position = "bottom", legend.title = element_blank())
sp
```


```{r}
sp <- ggplot(gap_data, aes(x = Coefficient, y = Gap, color = Group)) +
  geom_line(aes(group = 1), size = 0.8) +  # <--- this ensures all points are connected
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = Gap - 1.96 * Std_Error, ymax = Gap + 1.96 * Std_Error),
                width = 0.2, na.rm = TRUE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(values = c("Pre" = "#E87D72", "Post" = "#56BCC2")) +
  scale_x_discrete(breaks = paste0("tr", gap_data$Year),
                   labels = as.character(gap_data$Year)) +
  labs(
    title = "Gap between Treated Unit and Synthetic Control",
    x = "Year",
    y = "Gap in GDP Per Capita (R$)"
  ) +
  scale_y_continuous(
    labels = label_number(big.mark = ".", decimal.mark = ",", prefix = "R$ ")
  ) +
  theme_minimal() +
  theme(text = element_text(size = 10),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.y = element_line(color = "gray95", size = 0.7),
        panel.grid.minor.y = element_line(color = "gray95", size = 0.3),
        legend.position = "bottom") +
  annotate("text", x = "tr2019", y = min(gap_data$Gap), label = "Treatment Year", hjust = 1.1)+
  geom_vline(xintercept = which(levels(factor(gap_data$Coefficient)) == "tr2019"), 
           linetype = "dotted", color = "black", size = 1)
  #geom_vline(xintercept = 2019, linetype = "dotted", color = "black", size = 1)
sp
```


















